var $SPMTree,$SPMMsg,$SPMAddBtn,SPM=function(a,b){var c={};return c.statusCounts={},c.init=function(){c.$tooltips=a(".spm-tooltip").clone().tooltip(),$SPMAddBtn=a(".spm-no-pages"),this.getStatusCounts(),this.startListeners()},c.startListeners=function(){a(b).on("click",".spm-search-submit",function(){var b=c.getWrapper(this),d=a.trim(b.find(".spm-search").attr("value"));return d?(b.find(".spm-search-form-no-hits").fadeOut("fast"),b.find(".spm-search-form-working").fadeIn("fast"),b.find(".spm-search-form-reset"),$SPMTree.jstree("search",d),b.find(".spm-search-form-reset").fadeIn("fast")):(b.find(".spm-search-form-no-hits").fadeOut("fast"),b.find(".cms-tpv-container").jstree("clear_search"),b.find(".spm-search-form-reset").fadeOut("fast")),b.find(".spm-search-form-working").fadeOut("fast"),!1}),a(b).on("click","a.spm-search-form-reset",function(){var a=c.getWrapper(this);return a.find(".spm-search").val(""),$SPMTree.jstree("clear_search"),a.find(".spm-search-form-reset").fadeOut("fast"),a.find(".spm-search-form-no-hits").fadeOut("fast"),!1}),a(b).on("mouseenter",".spm-tooltip-button",c.openTooltipHandler),a(b).on("mouseleave",".spm-tooltip-button",c.closeTooltipHandler),a(b).on("click",".spm-tooltip-button",c.openTooltipHandler),a(b).on("click",c.closeTooltipHandler),a(b).on("click","a.spm-open-all",function(){return c.$tooltips.tooltip("close"),c.getWrapper(this).find(".spm-tree-container").jstree("open_all"),!1}),a(b).on("click","a.spm-close-all",function(){return c.$tooltips.tooltip("close"),c.getWrapper(this).find(".spm-tree-container").jstree("close_all"),!1}),a(b).on("click",".spm-page-tree-element",function(){var b=a(this).closest("li"),d="#"+b.attr("id");return c.$tooltips.tooltip("close"),c.resetPageTree(b),c.preparePageActionButtons(b),a.cookie("jstree_select",d),!1}),a(b).on("keyup","input[name=post_title].spm-new-page",function(b){var d,e=a(this).closest("li"),f=e.find("input[name=spm_is_custom_url]").val();return f&&"0"===f&&(d=c.generatePathToPage(e),setTimeout(function(){a.post(ajaxurl,{action:"spm_sanitize_url",url:b.currentTarget.value}).done(function(b){a("input[name=post_name]").val(c.generatePageUrl(d,b))})},100)),!1}),a(b).on("keyup","input[name=post_name]",function(){var b=a(this).closest("li"),c=b.find("input[name=spm_is_custom_url]").val();return c&&"0"===c&&b.find("input[name=spm_is_custom_url]").val("1"),!1}),a(b).on("change","input[name=add_mode].spm-new-page",function(){var b,d,e=a(this).closest("li"),f=e.find("input[name=spm_is_custom_url]").val();return c.validateSettings(e)?(f&&"0"===f&&(b=c.generatePathToPage(e),d=""!==e.find("input[name=post_title]").val()?e.find("input[name=post_name]").val().replace(/.*\/(.+)$/g,"$1"):"",a("input[name=post_name]").val(c.generatePageUrl(b,d))),!1):!1}),a(b).on("click",".spm-page-button:not(.button-primary-disabled)",function(){var b=a(this),d=b.closest("li"),e=b.data("spm-action");switch(c.$tooltips.tooltip("close"),e){case"add":case"settings":case"delete":case"publish":c.resetPageTree(d),d.data("cur-action")&&d.data("cur-action")===e||(c.preparePageActions(d,e),d.data("cur-action",e)),"settings"===e&&c.getPageSettings(d);break;case"edit":window.location=d.data("editlink");break;case"view":window.location=d.data("permalink");break;default:a(".spm-tmpl-container:visible").remove()}return!1}),a(b).on("click",".spm-do-button",function(){var b=a(this),d=b.closest("li"),e=b.data("spm-action"),f=a("input#_inline_edit");switch(c.$tooltips.tooltip("close"),e){case"save":var g,h=d.data("cur-action"),i=d.find("input[name=add_mode]:checked").val();if(!c.validateSettings(d))return!1;g={action:"spm_save_page",post_type:"page",post_title:d.find("input[name=post_title]").val(),add_mode:i,post_status:d.find("input[name=post_status]:checked").val(),page_template:d.find("select[name=page_template]").val(),post_name:d.find("input[name=post_name]").val()||d.find("input[name=spm_url]").val(),spm_is_custom_url:d.find("input[name=spm_is_custom_url]").val(),spm_show_in_menu:d.find("input[name=spm_show_in_menu]:checked").val()||"show",spm_page_title_seo:d.find("input[name=spm_page_title_seo]").val(),spm_header_visibility:d.find("input[name=spm_header_visibility]:checked").val(),spm_sidebar_visibility:d.find("input[name=spm_sidebar_visibility]:checked").val(),_inline_edit:f.val()},"add"===h?a.extend(!0,g,{parent_id:d.attr("id")}):"settings"===h&&a.extend(!0,g,{post_ID:d.data("post_id")}),a.post(ajaxurl,g).done(function(){if("add"===h&&"inside"===i){var b="#"+d.attr("id"),e=c.getOpenLiIdsFromCookie();-1===a.inArray(b,e)&&e.push(b),a.cookie("jstree_open",e.join(","))}$SPMTree.jstree("refresh")});break;case"delete":case"publish":a.post(ajaxurl,{action:"spm_"+e+"_page",post_ID:d.data("post_id"),_inline_edit:f.val()}).done(function(){$SPMTree.jstree("refresh")});break;case"cancel":a(".spm-tmpl-container:visible").remove();break;case"less":case"more":a(".spm-advanced-feature")["less"===e?"hide":"show"](),a(".spm-less")["less"===e?"hide":"show"](),a(".spm-more")["less"===e?"show":"hide"]();break;case"add":a.post(ajaxurl,{action:"spm_save_page",post_type:"page",post_title:"Home",post_status:"draft",add_mode:"after",page_template:"default",spm_show_in_menu:"show",_inline_edit:f.val()}).done(function(){$SPMTree.jstree("refresh")})}return!1})},c.openTooltipHandler=function(d){var e=a(this).hasClass("spm-tooltip-button")?a(this):a(this).closest(".spm-tooltip-button"),f="."+e.attr("rel"),g=c.$tooltips.filter(f);return"click"===d.type&&/(spm-tooltip-button|fa)/.test(d.target.className)&&(a(b).off("mouseenter",".spm-tooltip-button"),a(b).off("mouseleave",".spm-tooltip-button")),c.$tooltips.tooltip("close"),g.tooltip({items:g[0],content:g.html(),position:{of:e[0],my:"left bottom",at:"right top",collision:"flipfit"}}).tooltip("open"),d.stopImmediatePropagation(),!1},c.closeTooltipHandler=function(d){"click"!==d.type||/(spm-tooltip-button|fa)/.test(d.target.className)||(a(b).on("mouseleave",".spm-tooltip-button",c.closeTooltipHandler),a(b).on("mouseenter",".spm-tooltip-button",c.openTooltipHandler)),c.$tooltips.tooltip("close")},c.generatePageUrl=function(a,b){return""!==b&&(/\/$/.test(a)||(a+="/")),b=a+b,b.replace(/^\/|\/$/g,"")},c.generatePathToPage=function(a){var b=a.find("input[name=add_mode]:checked").val(),c=a.find("input[name=wp_site_url]").val(),d=a.data("permalink").replace(c,""),e="";return"after"===b&&(e=a.parent("ul").closest("li"),d=e.length?e.data("permalink").replace(c,""):""),d},c.adaptTreeLinkElements=function(b){a(b).css({width:"100%"}).attr({href:"javascript:;","class":"spm-page-tree-element"})},c.resetPageTree=function(b){var c=a(".spm-tree-container");c.find("li").data("cur-action",""),c.find(".spm-tmpl-container").remove(),c.find("a.jstree-clicked").not(b.find("> a")).removeClass("jstree-clicked")},c.validateSettings=function(a){var b=a.data("post_status"),c=a.find("input[name=add_mode]:checked").val(),d=1;return"draft"===b&&"inside"===c&&(jAlert(spm_l10n.no_sub_page_when_draft),a.find("input[name=add_mode]").val(["after"]),d=0),d},c.getPostType=function(a){return this.getWrapper(a).find("[name=spm_meta_post_type]").val()},c.getWrapper=function(b){return a(b).closest(".spm-wrapper")},c.preparePageActionButtons=function(a){var b=a.find("> a"),c=b.find(".post_type_draft").length,d=a.closest(".spm-tree-container"),e=this.getPageActionButtonsTmpl();d.find(".spm-page-actions-tmpl").remove(),e.find("span[data-spm-action=add]").toggleClass("button-primary-disabled",!a.hasClass("spm-can-add-inside")&&!a.hasClass("spm-can-add-after")),e.find("span[data-spm-action=settings]").toggleClass("button-primary-disabled",!a.hasClass("spm-can-edit")),e.find("span[data-spm-action=delete]").toggleClass("button-primary-disabled",!a.hasClass("spm-can-delete")),e.find("span[data-spm-action=edit]").toggleClass("button-primary-disabled",!a.hasClass("spm-can-edit")),e.find("span[data-spm-action=publish]").toggleClass("button-primary-disabled",!a.hasClass("spm-can-publish")),c||e.find("span[data-spm-action=publish]").hide(),b.addClass("jstree-clicked").append(e.removeAttr("style"))},c.getPageActionButtonsTmpl=function(){return a(".spm-page-actions-tmpl.__TMPL__").clone(!0).removeClass("__TMPL__")},c.preparePageActions=function(b,c){var d=this,e={add:"spm-page-add-edit-tmpl",settings:"spm-page-add-edit-tmpl","delete":"spm-page-delete-tmpl",publish:"spm-page-publish-tmpl"}[c],f=this.getPageActionsTmpl(e),g=f.find("input[name=is_swifty]").val();"add"===c&&(f.find("input[name=spm_show_in_menu][value=show]").prop("checked",!0),f.find("input[name=add_mode]").each(function(){var c=a(this).next().text();a(this).next().text(c+' "'+d.getLiText(b)+'"')}),f.find("input[name=add_mode]").val(["after"]),f.find("input[name=post_status]").val(["draft"]),f.find("input[name=post_name]").val(""),f.find("input[name=add_mode]").addClass("spm-new-page"),f.find("input[name=post_title]").addClass("spm-new-page")),"settings"===c&&f.find("input[name=add_mode]").closest(".inline-edit-group").hide(),+g&&f.find(".spm-advanced-feature").hide(),f.find("label.add_mode_inside").toggleClass("spm-label-disabled",!b.hasClass("spm-can-add-inside")),f.find(".spm-less").hide(),f.find(".spm-more").show(),b.data("cur-action",c),b.find("> a").after(f.removeAttr("style"))},c.getLiText=function(a){var b="";return a.find("> a").contents().filter(function(){3===this.nodeType&&(b=this.nodeValue)}),b},c.getPageActionsTmpl=function(b){return a("."+b+".__TMPL__").clone(!0).removeClass("__TMPL__")},c.pageTreeLoadedHandler=function(b,d){var e=a(b.target),f=a.cookie("jstree_select"),g=c.getOpenLiIdsFromCookie();c.adaptTreeLinkElements(e.find("a")),f?(c.preparePageActionButtons(a(f)),e.find(f+" > a").addClass("jstree-clicked")):(c.preparePageActionButtons(e.find("li:first")),e.find("li:first > a").addClass("jstree-clicked")),"refresh"===b.type&&(c.updateStatusCount(),a.each(g,function(a,b){d.inst.open_node(b,null,!0)}))},c.pageTreeSearchHandler=function(b,d){var e=d.rslt.str.toLowerCase(),f=a(this),g=d.rslt.nodes,h=g.length;if(h)for(;h--;){var i=a(g[h]),j=c.getLiText(i.closest("li"));-1===j.toLowerCase().indexOf(e)&&(i.removeClass("jstree-search"),g.splice(h,1))}g.length||f.closest(".spm-wrapper").find(".spm-search-form-no-hits").fadeIn("fast")},c.getOpenLiIdsFromCookie=function(){var b=a.cookie("jstree_open"),c=[];return b&&(c=b.split(",")),c},c.getPageSettings=function(b){a.post(ajaxurl,{action:"spm_post_settings",post_ID:b.data("post_id")})},c.updateStatusCount=function(){var b=a.Deferred();return a.ajax({url:location.href,cache:!1,dataType:"html",dataFilter:function(b){return a(".spm-status-links",b).get(0)}}).done(function(d){c.getStatusCounts(d),a.each(c.statusCounts,function(c,d){var e=a(".spm-status-"+c),f=e.closest("li");f.hasClass("spm-hidden")||"0"!==d||"any"===c||f.addClass("spm-hidden"),e.find(".count").text("("+d+")"),f.hasClass("spm-hidden")&&"1"===d&&"any"!==c&&f.removeClass("spm-hidden"),e.hasClass("current")&&e.data("spm-status")===c&&"0"===d&&b.resolve(f.siblings().find("a.spm-status-any").attr("href"))})}),b},c.getStatusCounts=function(b){var d=a('a[class^="spm-status-"]');b&&(d=a(b).find('a[class^="spm-status-"]')),d.each(function(){var b=a(this).find(".count").text().replace(/\((.+)\)/g,"$1"),d=a(this).data("spmStatus");c.statusCounts[d]=b})},c.setLabel=function(a,b){var c=a.find("a:first");c.find("ins").first().after(b)},c.bindCleanNodes=function(){$SPMTree.on("move_node.jstree",function(b,c){var d,e,f=a(c.rslt.o),g=a(c.rslt.r),h=a(c.rslt.or),i=c.rslt.p;"before"===i?(d=f.attr("id"),e=h.attr("id")):"after"===i?(d=f.attr("id"),e=g.attr("id")):("inside"===i||"last"===i)&&(i="inside",d=f.attr("id"),e=g.attr("id")),a.post(ajaxurl,{action:"spm_move_page",node_id:d,ref_node_id:e,type:i}).done(function(){$SPMTree.jstree("refresh")})}),$SPMTree.on("clean_node.jstree",function(b,d){var e=d.rslt.obj;e&&-1!==e&&e.each(function(b,d){var e=a(d),f=e.data("rel"),g=e.data("post_status"),h=spm_l10n["status_"+g+"_ucase"];e.data("done_spm_clean_node")||(e.data("done_spm_clean_node",!0),"password"===f&&c.setLabel(e,'<span class="post_protected" title="'+spm_l10n.password_protected_page+'">&nbsp;</span>'),h||(h=g),"publish"!==g&&c.setLabel(e,'<span class="post_type post_type_'+g+'">'+h+"</span>"),e.hasClass("spm-show-page-in-menu-no")&&c.setLabel(e,'<span class="spm-page-in-menu">'+spm_l10n.hidden_page+"</span>"))})})},c}(jQuery,document);jQuery(function(a){SPM.init(),$SPMTree=a(".spm-tree-container"),$SPMMsg=a(".spm-message");var b="36",c="34",d="36",e=".jstree ul, .jstree li { display:block; margin:0 0 0 0; padding:0 0 0 0; list-style-type:none; } .jstree li { display:block; min-height:"+b+"px; line-height:"+b+"px; white-space:nowrap; margin-left:18px; min-width:18px; } .jstree-rtl li { margin-left:0; margin-right:18px; } .jstree > ul > li { margin-left:0px; } .jstree-rtl > ul > li { margin-right:0px; } .jstree ins { display:inline-block; text-decoration:none; width:18px; height:"+b+"px; margin:0 0 0 0; padding:0; } .jstree a { display:inline-block; line-height:"+c+"px; height:"+c+"px; color:black; white-space:nowrap; text-decoration:none; padding:1px 2px; margin:0; } .jstree a:focus { outline: none; } .jstree a > ins { height:"+d+"px; width:16px; } .jstree a > .jstree-icon { margin-right:3px; } .jstree-rtl a > .jstree-icon { margin-left:3px; margin-right:0; } li.jstree-open > ul { display:block; } li.jstree-closed > ul { display:none; } #vakata-dragged { background-color: white; };",f={plugins:["themes","json_data","cookies","dnd","crrm","search","types"],core:{html_titles:!0},rules:{multiple:!1,drag_copy:!1},json_data:{ajax:{url:ajaxurl+"?action=spm_get_childs&post_type=page&status="+a.data(document,"spm_status"),data:function(a){return a.data?{id:a.data("post_id")}:void 0},success:function(a){if(null!==a&&a&&a.length)$SPMMsg.hide(),$SPMAddBtn.addClass("spm-hidden");else{var b=SPM.updateStatusCount();b.done(function(a){a?window.location=a:($SPMMsg.html("<p>"+spm_l10n.no_pages_found+"</p>"),$SPMMsg.show(),$SPMAddBtn.removeClass("spm-hidden"))})}},error:function(){}}},themes:{theme:"wordpress",dots:!0,icons:!0},crrm:{move:{check_move:function(b){var c=this._get_parent(b.o);return c?(c=-1===+c?this.get_container():c,c===b.np?!0:"inside"===b.p||"last"===b.p?!a(b.cr[0]).find(".post_type_draft").length:"before"===b.p||"after"===b.p?!0:c[0]&&b.np[0]&&c[0]===b.np[0]?!0:!1):!1}}}};a.vakata.css.add_sheet({str:e,title:"jstree_spm"}),$SPMTree.length>0&&SPM.bindCleanNodes(),$SPMTree.on("loaded.jstree refresh.jstree",SPM.pageTreeLoadedHandler),$SPMTree.on("search.jstree",SPM.pageTreeSearchHandler),$SPMTree.jstree(f)});